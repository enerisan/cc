<html xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>City Care</title>
    <link rel="stylesheet" href="/style.css">
    <link rel="icon" href="public/images/logo.ico"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>

</head>

<body>

<div class="WrapperBoss">
    <header th:replace="~{fragments/header::header}"></header>

    <main class="PageMain">
        <div class="PageMain-centralBox">
            <section class="PageMain-centralBox-infos">
                <h2>Mes Infos</h2>
                <div class="PageMain-centralBox-infos-card InfosCard">
                    <div class="InfosCard-imgBox">
                        <img class="InfosCard-imgBox-img" th:src="@{/images/avatar.webp}" alt="Avatar">
                    </div>
                    <div class="InfosCard-textBox">
                        <p class="InfosCard-textBox-title" th:text="|${user.firstname} ${user.lastname}|"></p>
                        <p class="InfosCard-textBox-email" th:text="|${user.email}|"></p>
                        <p class="InfosCard-textBox-tel" th:text="|${user.phone}|"></p>
                    </div>
                    <button class="InfosCard-btn" th:replace="~{fragments/svg-fragments :: nextPage-icon}"></button>

                </div>
            </section>
            <section class="PageMain-centralBox-map">
                <div class="PageMain-centralBox-map-header">
                    <h2>Signalements récents</h2>
                    <div class="AllSee">
                        <i class="fa-regular fa-eye" style="color: #124e78;"></i>
                        <a href="">Voir tous</a>
                    </div>
                </div>

                <div id="incident-map" class="PageMain-centralBox-map-wrapper">



                </div>
            </section>

<!--            <section class="PageMain-centralBox-statistics">-->
<!--                <div class="PageMain-centralBox-statistics-header">-->
<!--                    <h2>Estatistiques</h2>-->
<!--                </div>-->
<!--                <div class="PageMain-centralBox-statistics-wrapper">-->
<!--                    <div class="PageMain-centralBox-statistics-wrapper-graphic">-->
<!--                        <canvas class="myChart" id="myChart"></canvas>-->
<!--                    </div>-->
<!--                </div>-->
<!--            </section>-->
        </div>
    </main>
    <nav th:replace="~{fragments/bar::bar}" class="PageMain-bar"></nav>
    <footer th:replace="~{fragments/footer::footer}" class="PageFooter"></footer>
</div>

<script th:src="@{/script.js}" defer></script>
<!--<script th:inline="javascript">-->
<!--    /*<![CDATA[*/-->
<!--    console.log(/*[[${incidents}]]*/);-->
<!--    /*]]>*/-->
<!--</script>-->

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script th:inline="javascript">
    /*<![CDATA[*/
    // List of incidents from the backend (automatically converted to JSON by Thymeleaf)
    let incidents = /*[[${incidents}]]*/ [];
    console.log(incidents)

    // Center on Aix-en-Provence
    const aixCenter = [43.529742, 5.447427];

    // Initialize map
    const map = L.map('incident-map').setView(aixCenter, 13);

    // Base tile layer
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '© OpenStreetMap contributors'
    }).addTo(map);

    // Add markers for incidents
    incidents.forEach(incident => {
        if (incident.latitude && incident.longitude) {
            L.marker([incident.latitude, incident.longitude])
                .addTo(map)
                .bindPopup(`<b>Incident #${incident.id}</b><br>${incident.cityName}`);
        }
    });

    // Adjust map view to fit all incident markers
    let markers = incidents
        .filter(i => i.latitude && i.longitude)
        .map(i => L.marker([i.latitude, i.longitude]));

    if (markers.length > 0) {
        let group = L.featureGroup(markers);
        map.fitBounds(group.getBounds());
    }
    /*]]>*/
</script>


<!--<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>-->
<!--<script>let currentYear = new Date().getFullYear();-->
<!--const ctx = document.getElementById('myChart').getContext('2d');-->
<!--/* let dataset = [[${dataset}]]; */-->


<!--let dataset = [-->
<!--    ['Jan', 'Accessibilité', 20, '#1f77b4'],-->
<!--    ['Jan', 'Chaussée', 40, '#ff7f0e'],-->
<!--    ['Jan', 'Éclairage public', 30, '#2ca02c'],-->
<!--    ['Feb', 'Accessibilité', 25, '#1f77b4'],-->
<!--    ['Feb', 'Chaussée', 35, '#ff7f0e'],-->
<!--    ['Feb', 'Éclairage public', 28, '#2ca02c'],-->
<!--    ['Mar', 'Accessibilité', 22, '#1f77b4'],-->
<!--    ['Mar', 'Chaussée', 38, '#ff7f0e'],-->
<!--    ['Mar', 'Éclairage public', 33, '#2ca02c'],-->
<!--    ['Apr', 'Accessibilité', 30, '#1f77b4'],-->
<!--    ['Apr', 'Chaussée', 45, '#ff7f0e'],-->
<!--    ['Apr', 'Éclairage public', 25, '#2ca02c'],-->
<!--    ['May', 'Accessibilité', 28, '#1f77b4'],-->
<!--    ['May', 'Chaussée', 50, '#ff7f0e'],-->
<!--    ['May', 'Éclairage public', 29, '#2ca02c'],-->
<!--    ['Jun', 'Accessibilité', 35, '#1f77b4'],-->
<!--    ['Jun', 'Chaussée', 42, '#ff7f0e'],-->
<!--    ['Jun', 'Éclairage public', 31, '#2ca02c'],-->
<!--    ['Jul', 'Accessibilité', 40, '#1f77b4'],-->
<!--    ['Jul', 'Chaussée', 55, '#ff7f0e'],-->
<!--    ['Jul', 'Éclairage public', 37, '#2ca02c'],-->
<!--    ['Aug', 'Accessibilité', 38, '#1f77b4'],-->
<!--    ['Aug', 'Chaussée', 47, '#ff7f0e'],-->
<!--    ['Aug', 'Éclairage public', 32, '#2ca02c'],-->
<!--    ['Sep', 'Accessibilité', 29, '#1f77b4'],-->
<!--    ['Sep', 'Chaussée', 41, '#ff7f0e'],-->
<!--    ['Sep', 'Éclairage public', 34, '#2ca02c'],-->
<!--    ['Oct', 'Accessibilité', 33, '#1f77b4'],-->
<!--    ['Oct', 'Chaussée', 48, '#ff7f0e'],-->
<!--    ['Oct', 'Éclairage public', 36, '#2ca02c'],-->
<!--    ['Nov', 'Accessibilité', 27, '#1f77b4'],-->
<!--    ['Nov', 'Chaussée', 39, '#ff7f0e'],-->
<!--    ['Nov', 'Éclairage public', 31, '#2ca02c'],-->
<!--    ['Dec', 'Accessibilité', 45, '#1f77b4'],-->
<!--    ['Dec', 'Chaussée', 52, '#ff7f0e'],-->
<!--    ['Dec', 'Éclairage public', 40, '#2ca02c']-->
<!--];-->

<!--let labels = [];-->
<!--let previousLabel = '';-->
<!--let datasetFormated = {};-->
<!--dataset.forEach(item => {-->
<!--    let friend = item[1];-->
<!--    if (typeof datasetFormated[friend] === "undefined") {-->

<!--        datasetFormated[friend] = {-->
<!--            label: friend,-->
<!--            data: [item[2]],-->
<!--            backgroundColor: item[3],-->
<!--            stack: 'Stack 0'-->
<!--        };-->

<!--    } else {-->
<!--        datasetFormated[friend]['data'].push(item[2]);-->
<!--    }-->

<!--    let lbl = item[0];-->
<!--    if (lbl != previousLabel) {-->
<!--        labels.push(lbl);-->
<!--    }-->
<!--    previousLabel = lbl;-->
<!--});-->
<!--console.log(dataset);-->
<!--let dataChart = [];-->
<!--for (var key in datasetFormated) {-->
<!--    if (datasetFormated.hasOwnProperty(key)) {-->
<!--        dataChart.push(datasetFormated[key]);-->
<!--    }-->
<!--}-->
<!--console.log(dataChart);-->
<!--new Chart(ctx, {-->
<!--    type: 'bar',-->
<!--    data: {-->
<!--        labels: labels,-->
<!--        datasets: dataChart-->
<!--    },-->
<!--    options: {-->
<!--        plugins: {-->
<!--            title: {-->
<!--                display: true,-->
<!--                text: 'Statistiques signalements ' + currentYear-->
<!--            }-->
<!--        },-->
<!--        responsive: true,-->
<!--        interaction: {-->
<!--            intersect: false,-->
<!--        },-->
<!--        scales: {-->
<!--            x: {-->
<!--                stacked: true,-->
<!--            },-->
<!--            y: {-->
<!--                stacked: true-->
<!--            }-->
<!--        }-->
<!--    }-->
<!--});-->
<!--</script>-->
</body>


</html>