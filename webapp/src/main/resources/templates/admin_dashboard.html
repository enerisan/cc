<html xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>City Care</title>
    <link rel="stylesheet" href="/style.css">
    <link rel="icon" href="public/images/logo.ico"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>

</head>

<body>

<div class="WrapperBoss">
    <header th:replace="~{fragments/header::header}"></header>

    <main class="PageMain">
        <div class="PageMain-centralBox">
            <section class="PageMain-centralBox-infos">
                <h2>Mes Infos</h2>
                <div class="PageMain-centralBox-infos-card InfosCard">
                    <div class="InfosCard-imgBox">
                        <img class="InfosCard-imgBox-img" th:src="@{/images/avatar.webp}" alt="Avatar">
                    </div>
                    <div class="InfosCard-textBox">
                        <p class="InfosCard-textBox-title" th:text="|${user.firstname} ${user.lastname}|"></p>
                        <p class="InfosCard-textBox-email" th:text="|${user.email}|"></p>
                        <p class="InfosCard-textBox-tel" th:text="|${user.phone}|"></p>
                    </div>
                    <button class="InfosCard-btn" th:replace="~{fragments/svg-fragments :: nextPage-icon}"></button>

                </div>
            </section>
            <section class="PageMain-centralBox-statistics">
                <div class="PageMain-centralBox-statistics-header">
                    <h2>Statistiques</h2>
                    <div class="PageMain-centralBox-statistics AllSee">
                        <i class="fa-regular fa-eye" style="color: #124e78;"></i>
                        <a href="">Voir tous</a>
                    </div>
                </div>
                <div class="PageMain-centralBox-statistics-wrapper">
                    <canvas class="myChart" id="myChart"></canvas>
                </div>
            </section>
            <section class="PageMain-centralBox-map">
                <div class="PageMain-centralBox-map-header">
                    <h2>Signalements récents</h2>
                    <div class="AllSee">
                        <i class="fa-regular fa-eye" style="color: #124e78;"></i>
                        <a href="">Voir tous</a>
                    </div>
                </div>

                <div id="incident-map" class="PageMain-centralBox-map-wrapper">


                </div>
            </section>


        </div>
    </main>
    <nav th:replace="~{fragments/bar::bar}" class="PageMain-bar"></nav>
    <footer th:replace="~{fragments/footer::footer}" class="PageFooter"></footer>
</div>

<script th:src="@{/script.js}" defer></script>
<!--<script th:inline="javascript">-->
<!--    /*<![CDATA[*/-->
<!--    console.log(/*[[${incidents}]]*/);-->
<!--    /*]]>*/-->
<!--</script>-->

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script th:inline="javascript">
    /*<![CDATA[*/
    // List of incidents from the backend (automatically converted to JSON by Thymeleaf)
    let incidents = /*[[${incidents}]]*/ [];
    console.log(incidents)

    // Center on Aix-en-Provence
    const aixCenter = [43.529742, 5.447427];

    // Initialize map
    const map = L.map('incident-map').setView(aixCenter, 13);

    // Base tile layer
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '© OpenStreetMap contributors'
    }).addTo(map);

    // Add markers for incidents
    incidents.forEach(incident => {
        if (incident.latitude && incident.longitude) {
            L.marker([incident.latitude, incident.longitude])
                .addTo(map)
                .bindPopup(`<b>Incident #${incident.id}</b><br>${incident.cityName}`);
        }
    });

    // Adjust map view to fit all incident markers
    let markers = incidents
        .filter(i => i.latitude && i.longitude)
        .map(i => L.marker([i.latitude, i.longitude]));

    if (markers.length > 0) {
        let group = L.featureGroup(markers);
        map.fitBounds(group.getBounds());
    }
    /*]]>*/
</script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script th:inline="javascript">
    /* Obtener datos del backend */
    let dataset = [[${monthlyIncidents}]]; // Thymeleaf reemplaza esto con tu lista

    let labels = [];
    let datasetFormated = {};

    // Formatear los datos para Chart.js
    dataset.forEach(item => {
        let month = item[0];       // mes
        let category = item[1];    // categoría
        let count = item[2];       // cantidad
        let color = item[3];       // color

        // Inicializar categoría si no existe
        if (!datasetFormated[category]) {
            datasetFormated[category] = {
                label: category,
                data: [],
                backgroundColor: color,
                stack: 'Stack 0'
            };
        }

        // Añadir count en el índice correspondiente
        datasetFormated[category].data.push(count);

        // Guardar meses sin repetir
        if (!labels.includes(month)) {
            labels.push(month);
        }
    });

    // Convertir objeto a array
    let dataChart = Object.values(datasetFormated);

    // Crear gráfico
    const ctx = document.getElementById('myChart').getContext('2d');
    new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: dataChart
        },
        options: {
            plugins: {
                title: {
                    display: true,
                    text: 'Statistiques signalements ' + new Date().getFullYear()
                }
            },
            responsive: true,
            interaction: { intersect: false },
            scales: {
                x: { stacked: true },
                y: { stacked: true }
            }
        }
    });
</script>
</body>


</html>